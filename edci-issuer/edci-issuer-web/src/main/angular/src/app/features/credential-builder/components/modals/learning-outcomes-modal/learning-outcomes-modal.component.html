<ux-modal
    [id]="modalId"
    class="learningOutcomeModal"
    [titleLabel]="
        modalTitleBreadcrumb?.length > 0
            ? (modalTitleBreadcrumb | appOcbModalBreadcrumb: modalTitle)
            : modalTitle
    "
    (onClose)="closeModal(false)"
    customWidth="75%"
>
    <uxModalBody>
        <form class="form-group col-6 required" [formGroup]="formGroup">
            <label class="d-inline-flex control-label">
                {{ 'common.title' | translate }}
            </label>
            <input
                euiInputText
                type="text"
                class="form-control"
                [formControl]="defaultTitle"
                [attr.disabled]="language !== defaultLanguage ? '' : null"
            />
            <ux-control-feedback
                *ngIf="defaultTitle.errors?.maxlength"
                typeClass="danger"
            >
                {{ 'error.maxLength.255' | translate }}
            </ux-control-feedback>
            <ux-control-feedback
                *ngIf="
                    defaultTitle.invalid &&
                    defaultTitle.errors?.required &&
                    defaultTitle.touched
                "
                typeClass="danger"
            >
                {{ 'error.required' | translate }}
            </ux-control-feedback>
            <ux-control-feedback
                *ngIf="
                    defaultTitle.invalid &&
                    defaultTitle.errors?.onlySpaceError &&
                    defaultTitle.touched
                "
                typeClass="danger"
            >
                {{ 'error.noBlankSpaceOnly' | translate }}
            </ux-control-feedback>
        </form>
        <edci-cb-language-tabs
            *ngIf="selectedLanguages?.length > 0"
            [(selectedLanguages)]="selectedLanguages"
            [language]="language"
            (onLanguageChange)="languageTabSelected($event)"
            (onLanguageRemoved)="languageRemoved($event)"
            (onLanguageAdded)="languageAdded($event)"
        ></edci-cb-language-tabs>

        <div class="cb-modal-form-wrapper">
            <form class="col-12 form-group-container" [formGroup]="formGroup">
                <div
                    *ngIf="title.controls[language]"
                    class="form-group col-12 required"
                    [formGroup]="title"
                >
                    <label class="d-inline-flex control-label">
                        {{
                            'credential-builder.learning-outcomes-tab.learningOutcomeTitle'
                                | translate
                        }}
                        <span
                            uxTooltip="{{
                                'credential-builder.learning-outcomes-tab.tooltips.title'
                                    | translate
                            }}"
                            position="top-right"
                            size="large"
                        >
                            <eui-icon
                                iconClass="eui-icon-info-circle"
                            ></eui-icon>
                        </span>
                    </label>
                    <input
                        euiInputText
                        type="text"
                        class="form-control"
                        [formControl]="titleControl"
                    />

                    <ng-container
                        *ngFor="let control of title.controls | keyvalue"
                    >
                        <ux-control-feedback
                            *ngIf="
                                control.key === language &&
                                control.value.errors?.maxlength
                            "
                            typeClass="danger"
                        >
                            {{ 'error.maxLength.4000' | translate }}
                        </ux-control-feedback>
                        <ux-control-feedback
                            *ngIf="
                                control.key === language &&
                                control.value.invalid &&
                                control.value.errors?.required &&
                                control.value.touched
                            "
                            typeClass="danger"
                        >
                            {{ 'error.required' | translate }}
                        </ux-control-feedback>
                        <ux-control-feedback
                            *ngIf="
                                control.key === language &&
                                control.value.invalid &&
                                control.value.errors?.onlySpaceError &&
                                control.value.touched
                            "
                            typeClass="danger"
                        >
                            {{ 'error.noBlankSpaceOnly' | translate }}
                        </ux-control-feedback>
                    </ng-container>
                </div>

                <div class="col-12 d-inline-flex controlled-lists">
                    <div class="form-group pl-0 col-6">
                        <edci-controlled-list-select
                            label="{{
                                'credential-builder.learning-outcomes-tab.learningOutcomeType'
                                    | translate
                            }}"
                            entityType="skill-type"
                            [activeLanguage]="language"
                            [selectedLanguages]="selectedLanguages"
                            formControlName="learningOutcomeType"
                            [ngClass]="{
                                elementDisabled: !isPrimaryLanguage
                            }"
                        ></edci-controlled-list-select>
                    </div>

                    <div class="form-group pr-0 col-6">
                        <edci-controlled-list-select
                            label="{{
                                'credential-builder.learning-outcomes-tab.reusabilityLevel'
                                    | translate
                            }}"
                            entityType="skill-reuse-level"
                            [activeLanguage]="language"
                            [selectedLanguages]="selectedLanguages"
                            formControlName="reusabilityLevel"
                            [ngClass]="{
                                elementDisabled: !isPrimaryLanguage
                            }"
                        ></edci-controlled-list-select>
                    </div>
                </div>

                <div
                    *ngIf="description.controls[language]"
                    class="form-group col-12"
                    [formGroup]="description"
                >
                    <label class="d-inline-flex">
                        {{ 'common.description' | translate }}
                        <span
                            uxTooltip="{{
                                'credential-builder.learning-outcomes-tab.tooltips.description'
                                    | translate
                            }}"
                            position="top-right"
                            size="large"
                        >
                            <eui-icon
                                iconClass="eui-icon-info-circle"
                            ></eui-icon>
                        </span>
                    </label>
                    <div class="eui-textarea__wrapper">
                        <textarea
                            [formControl]="descriptionControl"
                            class="eui-textarea"
                            rows="3"
                        ></textarea>
                        <ng-container
                            *ngFor="let control of description.controls | keyvalue"
                        >
                            <ux-control-feedback
                                *ngIf="
                                    control.key === language &&
                                    control.value.errors?.maxlength
                                "
                                typeClass="danger"
                            >
                                {{ 'error.maxLength.4000' | translate }}
                            </ux-control-feedback>
                        </ng-container>
                    </div>
                </div>

                <div class="form-group col-12">
                    <label class="d-inline-flex">
                        {{
                            'credential-builder.learning-outcomes-tab.ESCO'
                                | translate
                        }}
                    </label>
                    <edci-controlled-list
                        entityType="skill"
                        [itemsSelected]="selectedEscoSkills"
                        [activeLanguage]="language"
                        [selectedLanguages]="selectedLanguages"
                        [isPrimaryLanguage]="isPrimaryLanguage"
                        (onError)="closeModal(false)"
                        (onItemsSelectionChange)="
                            occupationSelectionChange($event)
                        "
                        [ngClass]="{
                            elementDisabled: !isPrimaryLanguage
                        }"
                    ></edci-controlled-list>
                </div>

                <div
                    class="form-group col-12"
                    [formGroup]="relatedSkill"
                >
                    <label class="d-inline-flex">
                        {{ 'credential-builder.learning-outcomes-tab.relatedSkill' | translate }}
                        <span
                            uxTooltip="{{
                                'credential-builder.learning-outcomes-tab.tooltips.relatedSkill'
                                    | translate
                            }}"
                            position="top-right"
                            size="large"
                        >
                            <eui-icon
                                iconClass="eui-icon-info-circle"
                            ></eui-icon>
                        </span>
                    </label>
                    <input
                        euiInputText
                        type="text"
                        class="form-control mb-3"
                        [placeholder]="'frameworkUri'"
                        formControlName="frameworkUri"
                        [attr.disabled]="language !== defaultLanguage ? '' : null"
                    />
                    <ux-control-feedback
                        *ngIf="frameworkUri?.errors?.maxlength"
                        typeClass="danger"
                    >
                        {{ 'error.maxLength.255' | translate }}
                    </ux-control-feedback>
                    <ux-control-feedback
                        *ngIf="formGroup?.errors?.frameworkUriEmpty"
                        typeClass="danger"
                    >
                        {{ 'error.additionalNote' | translate }}
                    </ux-control-feedback>
                    <ux-control-feedback
                        *ngIf="
                            relatedSkill.controls.frameworkUri?.invalid &&
                            relatedSkill.controls.frameworkUri?.errors?.pattern &&
                            relatedSkill.controls.frameworkUri?.touched
                        "
                        typeClass="danger"
                    >
                        {{ 'error.urlPattern' | translate }}
                    </ux-control-feedback>
                    <input
                        euiInputText
                        type="text"
                        class="form-control mb-3"
                        [placeholder]="'Uri'"
                        formControlName="uri"
                        [attr.disabled]="language !== defaultLanguage ? '' : null"
                    />
                    <ux-control-feedback
                        *ngIf="uri?.errors?.maxlength"
                        typeClass="danger"
                    >
                        {{ 'error.maxLength.255' | translate }}
                    </ux-control-feedback>
                    <ux-control-feedback
                        *ngIf="formGroup?.errors?.uriEmpty"
                        typeClass="danger"
                    >
                        {{ 'error.additionalNote' | translate }}
                    </ux-control-feedback>
                    <ux-control-feedback
                        *ngIf="
                            relatedSkill.controls.uri?.invalid &&
                            relatedSkill.controls.uri?.errors?.pattern &&
                            relatedSkill.controls.uri?.touched
                        "
                        typeClass="danger"
                    >
                        {{ 'error.urlPattern' | translate }}
                    </ux-control-feedback>
                </div>
            <div
               *ngIf="name.controls[language] && ( filledRelatedSkill || isPrimaryLanguage)"
                class="form-group col-12"
                [formGroup]="name"
            >
                <input
                    euiInputText
                    type="text"
                    class="form-control mb-3"
                    [placeholder]="'Name'"
                    [formControl]="nameControls"
                />
                <ux-control-feedback
                    *ngIf="formGroup?.errors?.nameEmpty"
                    typeClass="danger"
                >
                    {{ 'error.additionalNote' | translate }}
                </ux-control-feedback>
            </div>
            </form>
        </div>
    </uxModalBody>

    <uxModalFooter>
        <edci-cb-modal-footer
            (onClose)="closeModal(false)"
            (onSave)="onSave()"
            [isDisabled]="isSaveDisabled"
        ></edci-cb-modal-footer>
    </uxModalFooter>
</ux-modal>

<div *ngIf="isLoading || isSaveDisabled" class="spinner-wrapper-full-screen">
    <mat-progress-spinner
        class="spinner"
        color="primary"
        mode="indeterminate"
        value="50"
    >
    </mat-progress-spinner>
</div>

<eui-message-box
    #messageBoxFormError
    typeClass="warning"
    title="{{ 'common.warning' | translate | uppercase }}"
    messageBoxType="ok"
>
    <p>{{ 'credential-builder.formError' | translate }}</p>
</eui-message-box>
